<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Analytics Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #8b4513; }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { 
            background: #8b4513; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #a0522d; }
        .code { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            padding: 10px; 
            border-radius: 3px; 
            font-family: monospace;
            margin: 10px 0;
        }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Cloudflare Analytics Test</h1>
        <p>This page helps you verify that Cloudflare Analytics is working correctly on your portfolio.</p>
        
        <div id="status-container">
            <div class="status warning">Testing Cloudflare Analytics setup...</div>
        </div>
        
        <h2>Setup Instructions:</h2>
        <ol>
            <li>Get your Cloudflare Web Analytics token from the dashboard</li>
            <li>Replace <code>YOUR_ACTUAL_CLOUDFLARE_TOKEN</code> in index.html with your real token</li>
            <li>Deploy your site or test locally</li>
            <li>Click the test buttons below</li>
        </ol>
        
        <h2>Tests:</h2>
        <button onclick="testCloudflareBeacon()">Test Cloudflare Beacon</button>
        <button onclick="testNetworkRequests()">Check Network Requests</button>
        <button onclick="testCustomEvents()">Test Custom Events</button>
        <button onclick="exportTestResults()">Export Test Results</button>
        
        <div id="test-results"></div>
        
        <h2>Expected Token Format:</h2>
        <div class="code">
            data-cf-beacon='{"token": "1234567890abcdef1234567890abcdef12345678", "spa": true}'
        </div>
        
        <h2>Verification Steps:</h2>
        <ol>
            <li><strong>Browser Console:</strong> Check for Cloudflare beacon object</li>
            <li><strong>Network Tab:</strong> Look for requests to beacon-v2.cloudflare.com</li>
            <li><strong>Cloudflare Dashboard:</strong> Check analytics data (wait 5-10 minutes)</li>
            <li><strong>Custom Events:</strong> Verify portfolio events are being tracked</li>
        </ol>
    </div>

    <script>
        let testResults = [];

        function logResult(test, status, message, details = {}) {
            const result = { test, status, message, details, timestamp: new Date().toISOString() };
            testResults.push(result);
            
            const container = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `status ${status}`;
            div.innerHTML = `
                <strong>${test}:</strong> ${message}
                ${Object.keys(details).length > 0 ? `<pre>${JSON.stringify(details, null, 2)}</pre>` : ''}
            `;
            container.appendChild(div);
        }

        function testCloudflareBeacon() {
            
            // Check if Cloudflare beacon is loaded
            if (typeof window.__cfBeacon !== 'undefined') {
                logResult('Cloudflare Beacon', 'success', 'Cloudflare beacon is loaded and active!', {
                    beacon: window.__cfBeacon
                });
            } else {
                logResult('Cloudflare Beacon', 'error', 'Cloudflare beacon not found. Check your token setup.');
            }
            
            // Check if beacon script is in DOM
            const beaconScript = document.querySelector('script[src*="beacon.min.js"]');
            if (beaconScript) {
                const dataBeacon = beaconScript.getAttribute('data-cf-beacon');
                if (dataBeacon && !dataBeacon.includes('PLACEHOLDER') && !dataBeacon.includes('YOUR_ACTUAL')) {
                    logResult('Beacon Script', 'success', 'Beacon script found with valid token configuration', {
                        config: dataBeacon
                    });
                } else {
                    logResult('Beacon Script', 'warning', 'Beacon script found but token appears to be placeholder', {
                        config: dataBeacon
                    });
                }
            } else {
                logResult('Beacon Script', 'error', 'Beacon script not found in DOM');
            }
        }

        function testNetworkRequests() {
            
            // This is informational - user needs to check Network tab manually
            logResult('Network Requests', 'warning', 'Check browser Network tab for requests to:', {
                expectedDomains: [
                    'static.cloudflare.com/beacon.min.js',
                    'beacon-v2.cloudflare.com',
                    'cloudflareinsights.com'
                ],
                instructions: 'Open DevTools > Network tab, refresh page, look for Cloudflare requests'
            });
        }

        function testCustomEvents() {
            
            // Simulate some custom events if analytics system exists
            if (typeof window.portfolioAnalytics !== 'undefined') {
                try {
                    // Test custom event tracking
                    window.portfolioAnalytics.track('test_event', { 
                        test: true, 
                        source: 'analytics_test_page',
                        timestamp: Date.now()
                    });
                    
                    logResult('Custom Events', 'success', 'Custom analytics system is working!', {
                        analyticsSystem: 'Portfolio Analytics System Active',
                        testEvent: 'test_event sent successfully'
                    });
                } catch (error) {
                    logResult('Custom Events', 'error', 'Error with custom analytics system', {
                        error: error.message
                    });
                }
            } else {
                logResult('Custom Events', 'warning', 'Portfolio analytics system not found (this is normal for test page)');
            }
        }

        function exportTestResults() {
            const results = {
                testDate: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                cloudflareBeacon: typeof window.__cfBeacon !== 'undefined' ? window.__cfBeacon : 'Not found',
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cloudflare-analytics-test-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logResult('Export', 'success', 'Test results exported successfully');
        }

        // Auto-run initial tests
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testCloudflareBeacon();
                testNetworkRequests();
                testCustomEvents();
            }, 1000);
        });

        // Update status
        function updateStatus() {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = '<div class="status success">‚úÖ Analytics test page loaded. Run tests above to verify setup.</div>';
        }

        setTimeout(updateStatus, 500);
    </script>
</body>
</html>